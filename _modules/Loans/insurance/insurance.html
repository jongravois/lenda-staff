<fieldset>
    <legend>Insurance</legend>
    <div class="container-fluid">
        <tabset>
            <tab heading="AGENT/AGENCY">
                <br/>
                <div class="col-md-8 col-md-offset-1">
                    <accordion close-others="true">
                        <!--<accordion close-others="false">-->
                        <accordion-group heading="No Agencies Found" ng-if="loan.insurance.agencies.length == 0">
                            There are no insurance agencies associated with this loan.
                        </accordion-group>
                        <accordion-group ng-repeat="a in loan.insurance.agencies" is-open="a.is_open">
                            <accordion-heading class="col-md-12">
                                {{a.agency.agency}}
                                <span>
                                    <i class="pull-right glyphicon glyphicon-chevron-down" ng-if="a.is_open"></i>
                                </span>
                                <span>
                                    <i class="pull-right glyphicon glyphicon-chevron-right" ng-if="!a.is_open"></i>
                                </span>
                            </accordion-heading>
                            <div class="col-md-6">
                                {{a.agency.agency}}
                                <br/>
                                {{a.agency.address}}
                                <br/>
                                {{a.agency.city}}, {{a.agency.state}}  {{a.agency.zip}}
                                <br/>
                                {{a.agency.phone|phone}}
                                <br/>
                                {{a.agency.email}}
                            </div>
                            <div class="col-md-6">
                                {{a.agents[0].agent.agent}}
                                <br/>
                                {{a.agents[0].agent.agent_phone|phone}}
                                <br/>
                                {{a.agents[0].agent.agent_email}}
                            </div>
                        </accordion-group>
                    </accordion>
                </div>
                <br/>
                <div class="row">
                    <div class="col-md-8 col-md-offset-1" style="margin:0 18px;">
                        <a ng-click="createNewAgency()" class="btn btn-xs btn-default"><span class="glyphicon glyphicon-plus-sign" style="color:#006837;"></span> Add New</a>
                        </p>
                    </div>
                </div>
                <br/>
                <div class="row" ng-if="addNewOne">
                    <div class="col-md-10 col-md-offset-1">
                        <form>
                            <label>Agency</label>
                            <input type="text" class="form-control" name="agency" ng-model="newAgency.agency"/>
                        </form>
                    </div>
                </div>
            </tab>
            <tab heading="POLICIES">
                <table class="table table-striped rowed" style="width:100% !important;">
                    <tr>
                        <th>Agent</th>
                        <th>ST | County</th>
                        <th>Crop</th>
                        <th>Practice</th>
                        <th>Type</th>
                        <th>Unit</th>
                        <th>Options</th>
                        <th>Level</th>
                        <th>Price</th>
                        <th>Premium</th>
                        <th>Late</th>
                        <th></th>
                    </tr>
                    <tr ng-repeat-start="p in loan.insurance.policies | orderBy: ['county_id', 'crop', 'practice']">
                        <td class="text-left">
                            <span
                                ng-if="p.stax && p.showStax"
                                ng-click="toggleStax(p.id)"
                                style="cursor:pointer;">
                                &blacktriangledown;&nbsp;
                            </span>
                            <span ng-if="p.stax && !p.showStax"
                                  ng-click="toggleStax(p.id)"
                                  style="cursor:pointer;">
                                &blacktriangleright;&nbsp;
                            </span>
                            <span ng-if="!p.stax">&nbsp;&nbsp;</span>
                            {{p.agent.agent}}
                        </td>
                        <td class="text-left">
                            {{p.county.locale}}
                        </td>
                        <td class="text-left">
                            {{p.crop.name}}
                        </td>
                        <td class="text-center">
                            {{p.practice}}
                        </td>
                        <td class="text-center">
                            {{p.type}}
                        </td>
                        <td class="text-center">
                            {{p.unit}}
                        </td>
                        <td class="text-center">
                            {{p.options}}
                        </td>
                        <td class="text-right">
                            {{p.ins_level|flexPercent:0}}
                        </td>
                        <td class="text-right">
                            {{p.ins_price|flexCurrency:4}}
                        </td>
                        <td class="text-right">
                            {{p.premium|flexCurrency:2}}
                        </td>
                        <td class="text-right cBlue" style="width:80px;">
                            {{p.planting_days|number:0}}
                        </td>
                        <td></td>
                    </tr>
                    <tr ng-repeat-end
                        ng-if="p.stax"
                        ng-show="p.showStax"
                        ng-hide="!p.showStax">
                        <td colspan="2">&nbsp;</td>
                        <td colspan="2" class="text-right">
                            <label style="font-weight: normal;">
                                STAX Loss Trigger:
                            </label>
                        </td>
                        <td>
                            <span class="cBlue">
                                {{p.stax_loss_trigger|flexPercent:0}}
                            </span>
                        </td>
                        <td colspan="2" class="text-right">
                            <label style="font-weight: normal;">
                                STAX Desired Range:
                            </label>&nbsp;
                        </td>
                        <td>
                            <span class="cBlue">
                                {{p.stax_desired_range|flexPercent:0}}
                            </span>
                        </td>
                        <td colspan="2" class="text-right">
                            <label style="font-weight: normal;">
                                STAX Protection Factor:
                            </label>&nbsp;
                        </td>
                        <td>
                            <span class="cBlue">
                                {{p.stax_protection_factor|flexPercent:0}}
                            </span>
                        </td>
                        <td></td>
                    </tr>
                </table>
                <p>
                    <a ng-click="createNewAgency()" class="btn btn-xs btn-default"><span class="glyphicon glyphicon-plus-sign" style="color:#006837;"></span> Add New</a>
                </p>
            </tab>
            <tab heading="DATABASE">
                <table class="table table-striped rowed" style="width:100% !important;">
                    <tr>
                        <th>ST | County</th>
                        <th>Crop</th>
                        <th>Practice</th>
                        <th>FSN</th>
                        <th>Landlord</th>
                        <th>Share</th>
                        <th>APH</th>
                    </tr>
                    <tr ng-repeat="d in loan.insurance.database | orderBy: ['state', 'county', 'crop', 'practice']">
                        <td class="text-left">
                            {{d.county.locale}}
                        </td>
                        <td class="text-left">
                            {{d.crop.name}}
                        </td>
                        <td class="text-center">
                            {{d.practice}}
                        </td>
                        <td class="text-left">
                            {{d.databases.farms[0].fsn}}
                        </td>
                        <td class="text-left">
                            {{landlord}}
                        </td>
                        <!--TODO: test if > policies::share & show paperclip and force upload of Permission to Insure -->
                        <td class="text-right">
                            <percent-edit-in-place value="d.share"></percent-edit-in-place>
                        </td>
                        <td class="text-right">
                            <digit-edit-in-place value="d.yield"></digit-edit-in-place>
                        </td>
                    </tr>
                </table>
            </tab>
        </tabset>
        <br><br>
        <div class="row">
            <div class="col-md-12 text-right">
                <button style="margin-right:10px;" class="btn btn-primary"
                        ng-click="updateLoanInsurance()">UPDATE
                </button>
            </div>
        </div>
    </div>
</fieldset>